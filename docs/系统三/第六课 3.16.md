## Hardware-Based Speculation

### 1. 主要结构

- 之前是直接写到结果寄存器（FP Regs），而现在是先到ROB中；![image-20230317103634951](../img/3.17/image-20230317103634951.png)

### 2. 指令阶段

- Issure：从FP Op Queue中获取指令；
- Execution：对操作数进行操作（EX）；
- Write result：结束执行（WB），把所有的结果写到ROB去；
- Commit：更新结果寄存器；

### 3. 一个例子

![image-20230317104041309](../img/3.17/image-20230317104041309.png)

- 保留栈区状态表![image-20230317104240809](../img/3.17/image-20230317104240809.png)
    - 主要是添加了Dest，用于记录写入的ROB的编号；
- ROB状态表![image-20230317104750098](../img/3.17/image-20230317104750098.png)
- 结果寄存器![image-20230317104815450](../img/3.17/image-20230317104815450.png)
    - 多了一行ROB和寄存器的对应表，按照编号从小到大提交；

### 4. 课堂作业

- 前面的所有阶段都和托马斯罗算法一模一样，只需要再托马斯罗算法后面再添加一列；
- ![image-20230317105257902](../img/3.17/image-20230317105257902.png)

- Cycle 1：第一条指令流出![image-20230317105328456](../img/3.17/image-20230317105328456.png)

- Cycle 2：第一条指令计算地址，第二条指令流出![image-20230317105642042](../img/3.17/image-20230317105642042.png)

- Cycle 3：第一条指令开始执行，第二条指令计算地址，第三条指令流出![image-20230317105757552](../img/3.17/image-20230317105757552.png)

- Cycle 4：第三条和第四条指令都要等F2，不能执行![image-20230317105915810](../img/3.17/image-20230317105915810.png)

- Cycle 5：第三条和第四条指令都要等F2，不能执行![image-20230317110153088](../img/3.17/image-20230317110153088.png)

- Cycle 6：第三条和第四条指令开始执行![image-20230317110246870](../img/3.17/image-20230317110246870.png)

- Cycle 8：FSUB写结果![image-20230317110503328](../img/3.17/image-20230317110503328.png)

- Cycle 11：![image-20230317110722109](../img/3.17/image-20230317110722109.png)

- Cycle 16：![image-20230317110802293](../img/3.17/image-20230317110802293.png)

- Cycle 17：第三条指令commit，FDIV等到了结果进入了EX段![image-20230317110824514](../img/3.17/image-20230317110824514.png)

- Cycle 18：![image-20230317110934648](../img/3.17/image-20230317110934648.png)

- Cycle 56：![image-20230317111000028](../img/3.17/image-20230317111000028.png)

- Cycle 57：![image-20230317111147090](../img/3.17/image-20230317111147090.png)

- Cycle 58：![image-20230317111248340](../img/3.17/image-20230317111248340.png)

- Cycle 59：![image-20230317111226870](../img/3.17/image-20230317111226870.png)

- ![image-20230317111308583](../img/3.17/image-20230317111308583.png)

### 5. 总结

- 执行乱序，提交顺序，可以保证程序能够顺序完成，但是硬件比较复杂；
